<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHARLES PLAYBACK - PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --primary: #fff159; 
            --primary-dark: #d4c63b;
            --accent: #3483fa; 
            --success: #00a650; 
            --danger: #ff4747; 
            --bg: #0a0a0a; 
            --card-bg: #161616; 
            --text: #ffffff;
            --text-dim: #a0a0a0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: #000; display: flex; justify-content: center; min-height: 100vh; color: var(--text); overflow-x: hidden; }

        .app-shell { width: 100%; max-width: 100%; background: var(--bg); min-height: 100vh; display: flex; flex-direction: column; }

        header { background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(10px); padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222; }

        .logo { font-family: 'Orbitron', sans-serif; font-size: 20px; color: var(--primary); letter-spacing: 1px; }

        .user-tag { background: #222; padding: 6px 14px; border-radius: 30px; font-size: 10px; font-weight: 800; color: var(--primary); border: 1px solid #333; }

        .nav-tabs { display: flex; background: rgba(18, 18, 18, 0.9); position: fixed; bottom: 0; width: 100%; z-index: 99; border-top: 1px solid #333; padding: 8px 0 12px 0; }

        .tab-btn { flex: 1; text-align: center; font-size: 10px; font-weight: 700; color: var(--text-dim); cursor: pointer; display: flex; flex-direction: column; gap: 4px; }
        .tab-btn.active { color: var(--primary); }

        .main-content { padding: 15px; flex-grow: 1; padding-bottom: 100px; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card-bg); border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid #252525; }

        .prod-card { background: var(--card-bg); border-radius: 24px; overflow: hidden; margin-bottom: 25px; border: 1px solid #222; }
        .prod-card img { width: 100%; height: 220px; object-fit: cover; }
        .prod-info { padding: 20px; }
        .price { color: var(--primary); font-size: 24px; font-weight: 800; display: block; margin-bottom: 15px; }

        .vitrine-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }

        input { width: 100%; padding: 16px; margin-bottom: 12px; border: 1px solid #333; border-radius: 14px; background: #000; color: #fff; }
        button { width: 100%; padding: 16px; border: none; border-radius: 14px; font-weight: 800; cursor: pointer; text-transform: uppercase; }

        .btn-primary { background: var(--primary); color: #000; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-outline { background: transparent; border: 1px solid #333; color: #fff; margin-top: 10px; }

        audio { width: 100%; margin: 15px 0; filter: invert(100%); }
        .status-blink { color: var(--primary); font-weight: 800; animation: blink 1s infinite; text-align: center; }
        @keyframes blink { 50% { opacity: 0.4; } }

        .admin-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .admin-table th, td { padding: 10px; border-bottom: 1px solid #222; text-align: left; }
    </style>
</head>
<body>

<div class="app-shell">
    <header>
        <div class="logo">CHARLES PRO</div>
        <div id="user-display" class="user-tag">Visitante</div>
    </header>

    <div class="main-content">
        <div id="page-loja" class="page active">
            <div id="vitrine" class="vitrine-grid"></div>
        </div>

        <div id="page-carrinho" class="page">
            <div class="card">
                <h2 style="margin-bottom:20px">Meu Carrinho</h2>
                <div id="lista-carrinho"></div>
                <div id="carrinho-total" style="font-size: 24px; color: var(--primary); font-weight: 800; margin: 20px 0;"></div>
                
                <div id="secao-pix">
                    <button id="btn-gerar-pix" class="btn-success" onclick="gerarPixMercadoPago()">FINALIZAR E PAGAR COM PIX</button>
                </div>

                <div id="container-pix" style="display:none; margin-top: 20px;"></div>
            </div>
        </div>

        <div id="page-conta" class="page">
            <div id="auth-box" class="card">
                <input type="email" id="auth-email" placeholder="E-mail">
                <input type="password" id="auth-password" placeholder="Senha">
                <div id="login-actions">
                    <button class="btn-primary" onclick="handleLogin()">Entrar</button>
                    <button class="btn-outline" onclick="toggleAuthMode(true)">Criar Conta</button>
                </div>
                <div id="signup-actions" style="display:none;">
                    <button class="btn-success" onclick="handleSignUp()">Cadastrar</button>
                    <button class="btn-outline" onclick="toggleAuthMode(false)">J√° tenho conta</button>
                </div>
            </div>
            <div id="profile-box" style="display:none;" class="card">
                <h3 id="profile-email"></h3><br>
                <button class="btn-primary" id="btn-admin" style="display:none; background:red; color:white; margin-bottom:10px;" onclick="showPage('admin')">Painel Admin</button>
                <button class="btn-outline" onclick="handleLogout()">Sair</button>
            </div>
        </div>

        <div id="page-downloads" class="page">
            <h2>Meus Playbacks</h2>
            <div id="downloads-list" class="vitrine-grid" style="margin-top:20px;"></div>
        </div>

        <div id="page-admin" class="page">
            <div class="card">
                <button class="btn-outline" onclick="showPage('conta')">Voltar</button>
                <h3>Pedidos</h3>
                <table class="admin-table">
                    <thead><tr><th>Usu√°rio</th><th>Status</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="corpo-tabela-admin"></tbody>
                </table>
            </div>
        </div>
    </div>

    <nav class="nav-tabs">
        <div id="tab-loja" class="tab-btn active" onclick="showPage('loja')"><span>üè†</span>LOJA</div>
        <div id="tab-carrinho" class="tab-btn" onclick="showPage('carrinho')"><span>üõí</span>CARRINHO</div>
        <div id="tab-downloads" class="tab-btn" onclick="showPage('downloads')"><span>üî•</span>PLAYBACKS</div>
        <div id="tab-conta" class="tab-btn" onclick="showPage('conta')"><span>üë§</span>CONTA</div>
    </nav>
</div>

<script>
    const SB_URL = 'https://yhwifmxfaqjsllqzvxkq.supabase.co';
    const SB_KEY = 'sb_publishable_S9gOQ0dXOn8GHD6eW2dTTQ_cFNO29o9';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);
    
    const MP_ACCESS_TOKEN = 'APP_USR-8335565918085551-091112-1dbd4cf06467f67998b86460d23f62e4-2681443029';

    let currentUser = null;
    let carrinho = JSON.parse(localStorage.getItem('MP_CART')) || [];

    async function init() {
        const { data: { session } } = await _supabase.auth.getSession();
        if(session) updateUserStatus(session.user);
        renderLoja();
        updateCartUI();
    }

    async function gerarPixMercadoPago() {
        if(!currentUser) { alert("Fa√ßa login primeiro!"); return showPage('conta'); }
        if(carrinho.length === 0) return alert("Carrinho vazio!");

        const btn = document.getElementById('btn-gerar-pix');
        btn.disabled = true;
        btn.innerText = "CONECTANDO AO MERCADO PAGO...";

        const total = carrinho.reduce((a, b) => a + b.preco, 0);

        const paymentData = {
            transaction_amount: total,
            description: `Pedido Charles Playback - ${currentUser.email}`,
            payment_method_id: 'pix',
            payer: {
                email: currentUser.email,
                first_name: 'Cliente',
                last_name: 'Charles'
            }
        };

        try {
            const response = await fetch('https://api.mercadopago.com/v1/payments', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${MP_ACCESS_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(paymentData)
            });

            const data = await response.json();

            if (data.point_of_interaction) {
                const copiaCola = data.point_of_interaction.transaction_data.qr_code;
                const img64 = data.point_of_interaction.transaction_data.qr_code_base64;

                // Salva pedido no Supabase
                await _supabase.from('pedidos').insert([{
                    usuario: currentUser.email,
                    usuario_id: currentUser.id,
                    items: JSON.stringify(carrinho),
                    mp_id: data.id.toString(),
                    status: 'pendente'
                }]);

                exibirTelaPix(copiaCola, img64);
                monitorarPagamento(data.id);
            } else {
                console.error("Erro MP:", data);
                alert("Erro ao gerar Pix: " + (data.message || "Verifique o valor (m√≠nimo R$ 1,00)"));
            }
        } catch (error) {
            console.error("Erro Conex√£o:", error);
            alert("Erro de conex√£o. Se estiver no PC, tente usar a extens√£o 'Allow CORS' ou publique o site.");
        } finally {
            btn.disabled = false;
            btn.innerText = "FINALIZAR E PAGAR COM PIX";
        }
    }

    function exibirTelaPix(txt, img) {
        document.getElementById('secao-pix').style.display = 'none';
        const container = document.getElementById('container-pix');
        container.style.display = 'block';
        container.innerHTML = `
            <div style="text-align:center; padding:20px; border:2px solid var(--primary); border-radius:20px; background:#000;">
                <h3 style="color:var(--primary); margin-bottom:15px;">QR CODE GERADO</h3>
                <img src="data:image/jpeg;base64,${img}" style="width:200px; border:5px solid white; border-radius:10px; margin-bottom:15px;">
                <button class="btn-outline" onclick="copyText('${txt}')">COPIAR C√ìDIGO PIX</button>
                <div class="status-blink" style="margin-top:20px;">AGUARDANDO PAGAMENTO...</div>
            </div>`;
    }

    function copyText(t) { navigator.clipboard.writeText(t); alert("Copiado!"); }

    function monitorarPagamento(id) {
        const interval = setInterval(async () => {
            try {
                const res = await fetch(`https://api.mercadopago.com/v1/payments/${id}`, {
                    headers: { 'Authorization': `Bearer ${MP_ACCESS_TOKEN}` }
                });
                const data = await res.json();
                if (data.status === 'approved') {
                    clearInterval(interval);
                    await _supabase.from('pedidos').update({ status: 'aprovado' }).eq('mp_id', id.toString());
                    alert("PAGAMENTO APROVADO!");
                    carrinho = [];
                    localStorage.removeItem('MP_CART');
                    showPage('downloads');
                }
            } catch (e) { console.log("Checando..."); }
        }, 5000);
    }

    // --- FUN√á√ïES DE INTERFACE ---
    function showPage(p) {
        document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
        document.getElementById('tab-' + p).classList.add('active');
        if(p === 'downloads') renderDownloads();
        if(p === 'admin') carregarPedidosAdmin();
    }

    async function renderLoja() {
        const { data } = await _supabase.from('musicas').select('*');
        if(data) {
            document.getElementById('vitrine').innerHTML = data.map(p => `
                <div class="prod-card">
                    <img src="${p.imagen_u || p.Imagen_u}">
                    <div class="prod-info">
                        <h3>${p.nome || p.Nome}</h3>
                        <span class="price">R$ ${parseFloat(p.pre√ßo || p.Pre√ßo).toFixed(2)}</span>
                        <audio controls src="${p.Audio_url}"></audio>
                        <button class="btn-primary" onclick="addCarrinho(${p.id}, '${p.nome || p.Nome}', ${p.pre√ßo || p.Pre√ßo})">Adicionar</button>
                    </div>
                </div>`).join('');
        }
    }

    function addCarrinho(id, nome, preco) {
        carrinho.push({ id, nome, preco, tempId: Date.now() });
        localStorage.setItem('MP_CART', JSON.stringify(carrinho));
        updateCartUI();
        showPage('carrinho');
    }

    function updateCartUI() {
        const lista = document.getElementById('lista-carrinho');
        lista.innerHTML = carrinho.length === 0 ? "<p>Vazio</p>" : carrinho.map(i => `
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>${i.nome}</span>
                <button onclick="removeCart(${i.tempId})" style="width:30px; padding:2px;">X</button>
            </div>`).join('');
        document.getElementById('carrinho-total').innerText = "Total: R$ " + carrinho.reduce((a,b)=>a+b.preco, 0).toFixed(2);
    }

    function removeCart(tid) {
        carrinho = carrinho.filter(i => i.tempId !== tid);
        localStorage.setItem('MP_CART', JSON.stringify(carrinho));
        updateCartUI();
    }

    async function renderDownloads() {
        if(!currentUser) return;
        const { data } = await _supabase.from('pedidos').select('*').eq('usuario_id', currentUser.id);
        const container = document.getElementById('downloads-list');
        container.innerHTML = "";
        data?.forEach(p => {
            const items = JSON.parse(p.items);
            items.forEach(item => {
                container.innerHTML += `
                    <div class="card">
                        <h4>${item.nome}</h4>
                        ${p.status === 'aprovado' ? `<button class="btn-success" onclick="baixar(${item.id})">BAIXAR</button>` : '<p class="status-blink">AGUARDANDO APROVA√á√ÉO</p>'}
                    </div>`;
            });
        });
    }

    async function baixar(id) {
        const { data } = await _supabase.from('musicas').select('audio_completo').eq('id', id).single();
        if(data) window.open(data.audio_completo, '_blank');
    }

    // --- AUTH ---
    function toggleAuthMode(s) {
        document.getElementById('login-actions').style.display = s ? 'none' : 'block';
        document.getElementById('signup-actions').style.display = s ? 'block' : 'none';
    }

    async function handleLogin() {
        const e = document.getElementById('auth-email').value;
        const s = document.getElementById('auth-password').value;
        const { data, error } = await _supabase.auth.signInWithPassword({ email: e, password: s });
        if (error) alert(error.message); else updateUserStatus(data.user);
    }

    async function handleSignUp() {
        const e = document.getElementById('auth-email').value;
        const s = document.getElementById('auth-password').value;
        const { data, error } = await _supabase.auth.signUp({ email: e, password: s });
        if (error) alert(error.message); else alert("Confirme o e-mail!");
    }

    async function handleLogout() { await _supabase.auth.signOut(); location.reload(); }

    async function updateUserStatus(user) {
        currentUser = user;
        document.getElementById('user-display').innerText = user.email.split('@')[0];
        document.getElementById('auth-box').style.display = 'none';
        document.getElementById('profile-box').style.display = 'block';
        document.getElementById('profile-email').innerText = user.email;
        
        const { data } = await _supabase.from('profiles').select('is_admin').eq('id', user.id).single();
        if(data?.is_admin) document.getElementById('btn-admin').style.display = 'block';
    }

    async function carregarPedidosAdmin() {
        const { data } = await _supabase.from('pedidos').select('*').order('id', {ascending: false});
        document.getElementById('corpo-tabela-admin').innerHTML = data.map(p => `
            <tr>
                <td>${p.usuario}</td>
                <td>${p.status}</td>
                <td><button onclick="aprovarManual(${p.id})">Aprovar</button></td>
            </tr>`).join('');
    }

    async function aprovarManual(id) {
        await _supabase.from('pedidos').update({status:'aprovado'}).eq('id', id);
        alert('Aprovado!'); carregarPedidosAdmin();
    }

    init();
</script>
</body>
</html>
