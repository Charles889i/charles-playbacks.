<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHARLES PLAYBACK - PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* MANTIDO TODO O SEU ESTILO ORIGINAL */
        :root { 
            --primary: #fff159; 
            --primary-dark: #d4c63b;
            --accent: #3483fa; 
            --success: #00a650; 
            --danger: #ff4747; 
            --bg: #0a0a0a; 
            --card-bg: #161616; 
            --text: #ffffff;
            --text-dim: #a0a0a0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: #000; display: flex; justify-content: center; min-height: 100vh; color: var(--text); overflow-x: hidden; }

        .app-shell { width: 100%; max-width: 100%; background: var(--bg); min-height: 100vh; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

        @media (min-width: 768px) {
            .app-shell { max-width: 1200px; margin: 0 auto; }
            .nav-tabs { max-width: 1200px !important; left: 50% !important; transform: translateX(-50%); }
        }

        header { background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(10px); padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222; }

        .logo { font-family: 'Orbitron', sans-serif; font-size: 20px; color: var(--primary); letter-spacing: 1px; text-shadow: 0 0 10px rgba(255, 241, 89, 0.3); }

        .user-tag { background: #222; padding: 6px 14px; border-radius: 30px; font-size: 10px; font-weight: 800; text-transform: uppercase; border: 1px solid #333; color: var(--primary); }

        .nav-tabs { display: flex; background: rgba(18, 18, 18, 0.9); backdrop-filter: blur(15px); position: fixed; bottom: 0; width: 100%; z-index: 99; border-top: 1px solid #333; padding: 8px 0 12px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.8); }

        .tab-btn { flex: 1; padding: 10px 0; text-align: center; font-size: 10px; font-weight: 700; color: var(--text-dim); cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; gap: 4px; position: relative; }

        .tab-btn span:first-child { font-size: 18px; transition: transform 0.3s; }
        .tab-btn.active { color: var(--primary); }
        .tab-btn.active span:first-child { transform: translateY(-3px) scale(1.2); filter: drop-shadow(0 0 8px var(--primary)); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); width: 20px; height: 3px; background: var(--primary); border-radius: 10px; box-shadow: 0 0 10px var(--primary); }

        .main-content { padding: 15px; flex-grow: 1; padding-bottom: 100px; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid #252525; }

        .prod-card { background: var(--card-bg); border-radius: 24px; overflow: hidden; margin-bottom: 25px; border: 1px solid #222; transition: transform 0.2s; }
        .prod-card img { width: 100%; height: 220px; object-fit: cover; }
        .prod-info { padding: 20px; }
        .price { color: var(--primary); font-size: 24px; font-weight: 800; margin-bottom: 15px; display: block; }

        .vitrine-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }

        input { width: 100%; padding: 16px; margin-bottom: 12px; border: 1px solid #333; border-radius: 14px; background: #000; color: #fff; font-size: 14px; }
        button { width: 100%; padding: 16px; border: none; border-radius: 14px; font-weight: 800; cursor: pointer; transition: 0.2s; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }

        .btn-primary { background: var(--primary); color: #000; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-outline { background: rgba(255,255,255,0.05); border: 1px solid #333; color: #fff; margin-top: 10px; }

        audio { width: 100%; height: 40px; margin: 15px 0; border-radius: 30px; filter: invert(100%) hue-rotate(180deg) brightness(1.5); }

        .status-blink { color: var(--primary); font-weight: 800; animation: blink 1s infinite; font-size: 12px; }
        @keyframes blink { 50% { opacity: 0.4; } }

        .admin-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 15px; }
        .admin-table th { color: var(--text-dim); text-align: left; padding: 10px; border-bottom: 1px solid #333; }
        .admin-table td { padding: 12px 10px; border-bottom: 1px solid #222; }

        .url-output { background: #000 !important; color: var(--primary) !important; font-family: 'Courier New', monospace; font-size: 11px; margin-top: 10px; border: 1px dotted var(--primary); }
    </style>
</head>
<body>

<div class="app-shell">
    <header>
        <div class="logo">CHARLES PRO</div>
        <div id="user-display" class="user-tag">Visitante</div>
    </header>

    <div class="main-content">
        <div id="page-loja" class="page active">
            <div id="vitrine" class="vitrine-grid"></div>
        </div>

        <div id="page-carrinho" class="page">
            <div class="card">
                <h2 style="margin-bottom:20px">Meu Carrinho</h2>
                <div id="lista-carrinho"></div>
                <div id="carrinho-total" style="font-size: 28px; color: var(--primary); font-weight: 900; margin: 20px 0; border-top: 1px solid #333; padding-top: 20px;"></div>
                
                <div id="secao-pix-auto" style="margin-bottom: 30px;">
                    <button id="btn-gerar-pix" class="btn-primary" onclick="gerarPixMercadoPago()" style="background: #3483fa; color: #fff;">GERAR PIX AUTOM√ÅTICO</button>
                    <div id="container-pix" style="display:none; margin-top: 20px;"></div>
                </div>

                <hr style="border: 0; border-top: 1px solid #222; margin: 20px 0;">

                <div id="secao-pix-manual">
                    <h4 style="margin-bottom: 10px; font-size: 12px; color: var(--text-dim);">OU PAGAMENTO MANUAL:</h4>
                    <div style="background: rgba(52, 131, 250, 0.1); padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 1px dashed var(--accent);">
                        <small style="color: var(--accent); font-weight: 700; display: block; margin-bottom: 5px;">CHAVE PIX MANUAL:</small>
                        <code style="font-size: 16px; font-weight: 800; color: #fff;">88994387701</code>
                        <button class="btn-outline" style="padding: 10px; font-size: 12px;" onclick="copyPix()">Copiar Chave</button>
                    </div>

                    <label style="font-size: 12px; color: #888; margin-bottom: 8px; display: block;">Anexe o comprovante (Foto):</label>
                    <input type="file" id="comprovante-file" accept="image/*">
                    <button id="btn-enviar-comp" class="btn-success" onclick="enviarComprovante()">Finalizar Manualmente</button>
                </div>
            </div>
        </div>

        <div id="page-conta" class="page">
            <div id="auth-box" class="card" style="margin-top: 20px; max-width: 400px; margin-left: auto; margin-right: auto;">
                <h3 style="margin-bottom: 20px; text-align: center;">Bem-vindo</h3>
                <input type="email" id="auth-email" placeholder="Seu e-mail">
                <input type="password" id="auth-password" placeholder="Sua senha">
                <div id="login-actions">
                    <button class="btn-primary" onclick="handleLogin()">Entrar agora</button>
                    <button class="btn-outline" onclick="toggleAuthMode(true)">N√£o tenho conta</button>
                </div>
                <div id="signup-actions" style="display:none;">
                    <button class="btn-success" onclick="handleSignUp()">Criar minha conta</button>
                    <button class="btn-outline" onclick="toggleAuthMode(false)">J√° sou cliente</button>
                </div>
            </div>

            <div id="profile-box" style="display:none; max-width: 400px; margin-left: auto; margin-right: auto;">
                <div class="card" style="text-align: center;">
                    <div style="width: 70px; height: 70px; background: var(--primary); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: #000; font-size: 26px; font-weight: 900;">C</div>
                    <h3 id="profile-email" style="margin-bottom: 20px; color: var(--text-dim); font-size: 14px;"></h3>
                    <button id="btn-acesso-admin" class="btn-primary" style="margin-bottom:10px; background: var(--danger); color: white; display:none;" onclick="verificarAdmin()">Painel de Controle</button>
                    <button class="btn-outline" onclick="handleLogout()">Sair da Conta</button>
                </div>
                <div class="card">
                    <h4 style="margin-bottom: 15px; font-size: 14px; text-transform: uppercase; color: var(--primary);">Nossas Redes</h4>
                    <a href="https://www.youtube.com/@CharlesTeclas" target="_blank" class="social-link" style="text-decoration:none; color:#fff; display:block; margin-bottom:10px;">‚ñ∂ YouTube: Charles Teclas</a>
                    <a href="https://www.instagram.com/Charles_teclas1" target="_blank" class="social-link" style="text-decoration:none; color:#fff; display:block;">‚óè Instagram: Charles_teclas1</a>
                </div>
            </div>
        </div>

        <div id="page-downloads" class="page">
            <h2 style="margin: 0 0 20px 5px;">Meus Playbacks</h2>
            <div id="downloads-list" class="vitrine-grid"></div>
        </div>

        <div id="page-admin" class="page">
            <div class="card">
                <button class="btn-outline" style="margin-bottom: 20px;" onclick="showPage('conta')">‚¨Ö Sair</button>
                <h3>Pedidos Pendentes</h3>
                <table class="admin-table">
                    <thead><tr><th>Cliente</th><th>Provante</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="corpo-tabela-admin"></tbody>
                </table>
            </div>
            
            <div class="card">
                <h4>Cadastrar Novo Playback</h4>
                <input type="file" id="up-capa" accept="image/*">
                <input type="file" id="up-audio" accept="audio/*">
                <button class="btn-primary" id="btn-upload-admin" onclick="gerarLinkGenerico()">Subir e Gerar Links</button>
                <input type="text" id="out-capa" class="url-output" readonly placeholder="Link Capa">
                <input type="text" id="out-audio" class="url-output" readonly placeholder="Link √Åudio">
            </div>
        </div>
    </div>

    <nav class="nav-tabs">
        <div id="tab-loja" class="tab-btn active" onclick="showPage('loja')"><span>üè†</span>IN√çCIO</div>
        <div id="tab-carrinho" class="tab-btn" onclick="showPage('carrinho')"><span>üõí</span>CARRINHO</div>
        <div id="tab-downloads" class="tab-btn" onclick="showPage('downloads')"><span>üî•</span>PLAYBACKS</div>
        <div id="tab-conta" class="tab-btn" onclick="showPage('conta')"><span>üë§</span>PERFIL</div>
    </nav>
</div>

<script>
    const SB_URL = 'https://yhwifmxfaqjsllqzvxkq.supabase.co';
    const SB_KEY = 'sb_publishable_S9gOQ0dXOn8GHD6eW2dTTQ_cFNO29o9';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);
    
    // Token Mercado Pago
    const MP_ACCESS_TOKEN = 'APP_USR-8335565918085551-091112-1dbd4cf06467f67998b86460d23f62e4-2681443029';

    let currentUser = null, carrinho = JSON.parse(localStorage.getItem('MP_CART')) || [];

    // --- SISTEMA DE DIAGN√ìSTICO ---
    function diagnostico(local, erro) {
        console.group("üîç DIAGN√ìSTICO DE ERRO CHARLES PRO");
        console.error("Local do Conflito:", local);
        console.error("Detalhes:", erro);
        console.groupEnd();
        
        let msg = `‚ö†Ô∏è ERRO ENCONTRADO EM: ${local}\n\n`;
        if(erro.message?.includes('fetch')) msg += "Poss√≠vel erro de conex√£o/CORS. Publique o site ou use extens√£o.";
        else if(erro.message?.includes('transaction_amount')) msg += "O Mercado Pago exige valor m√≠nimo de R$ 1,00.";
        else msg += erro.message || "Erro desconhecido. Verifique o console (F12).";
        
        alert(msg);
    }

    async function init() {
        try {
            const { data: { session } } = await _supabase.auth.getSession();
            if(session) updateUserStatus(session.user);
            renderL(); 
            updateCartUI();
        } catch (e) { diagnostico("Inicializa√ß√£o Supabase", e); }
    }

    // --- FUN√á√ïES PIX AUTOM√ÅTICO (MERCADO PAGO) ---
    async function gerarPixMercadoPago() {
        if(!currentUser) return showPage('conta');
        if(carrinho.length === 0) return alert("Carrinho vazio!");

        const btn = document.getElementById('btn-gerar-pix');
        btn.disabled = true; btn.innerText = "CONECTANDO...";
        const total = carrinho.reduce((a,b)=>a+b.preco, 0);

        try {
            const response = await fetch('https://api.mercadopago.com/v1/payments', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${MP_ACCESS_TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    transaction_amount: total,
                    description: `Charles Playbacks - ${currentUser.email}`,
                    payment_method_id: 'pix',
                    payer: { email: currentUser.email, first_name: 'Cliente', last_name: 'Pro' }
                })
            });

            const data = await response.json();

            if(data.point_of_interaction) {
                const copiaCola = data.point_of_interaction.transaction_data.qr_code;
                const img64 = data.point_of_interaction.transaction_data.qr_code_base64;
                
                // Salva no Supabase (Originalmente salvando como pedido pendente)
                await _supabase.from('pedidos').insert([{ 
                    usuario: currentUser.email, usuario_id: currentUser.id, 
                    items: JSON.stringify(carrinho), mp_id: data.id.toString(), status: 'pendente' 
                }]);

                exibirTelaPix(copiaCola, img64);
                monitorarPagamento(data.id);
            } else {
                diagnostico("Resposta Mercado Pago", data);
            }
        } catch (e) { 
            diagnostico("Conex√£o/HTML Fetch", e); 
        } finally { 
            btn.disabled = false; btn.innerText = "GERAR PIX AUTOM√ÅTICO"; 
        }
    }

    function exibirTelaPix(txt, img) {
        document.getElementById('btn-gerar-pix').style.display = 'none';
        document.getElementById('secao-pix-manual').style.display = 'none';
        const container = document.getElementById('container-pix');
        container.style.display = 'block';
        container.innerHTML = `
            <div style="text-align:center; padding:20px; border:2px solid var(--primary); border-radius:20px; background:#000;">
                <h3 style="color:var(--primary); margin-bottom:15px;">PIX GERADO!</h3>
                <img src="data:image/jpeg;base64,${img}" style="width:200px; border-radius:10px; margin-bottom:15px; border: 5px solid white;">
                <button class="btn-outline" onclick="copyTxt('${txt}')">COPIAR C√ìDIGO PIX</button>
                <div class="status-blink" style="margin-top:20px">AGUARDANDO PAGAMENTO...</div>
            </div>`;
    }

    function monitorarPagamento(id) {
        const interval = setInterval(async () => {
            try {
                const r = await fetch(`https://api.mercadopago.com/v1/payments/${id}`, { headers: {'Authorization': `Bearer ${MP_ACCESS_TOKEN}`} });
                const d = await r.json();
                if(d.status === 'approved') {
                    clearInterval(interval);
                    await _supabase.from('pedidos').update({ status: 'aprovado' }).eq('mp_id', id.toString());
                    alert("‚úÖ PAGAMENTO APROVADO AUTOMATICAMENTE!");
                    carrinho = []; localStorage.removeItem('MP_CART');
                    showPage('downloads');
                }
            } catch (e) { console.log("Verificando status..."); }
        }, 5000);
    }

    // --- FUN√á√ïES ORIGINAIS MANTIDAS (SUPABASE / ADMIN / DOWNLOADS) ---
    async function verificarAdmin() {
        const { data } = await _supabase.from('profiles').select('is_admin').eq('id', currentUser.id).single();
        if (data?.is_admin) showPage('admin'); else alert("Voc√™ n√£o √© Admin.");
    }

    function copyPix() { navigator.clipboard.writeText("88994387701").then(() => alert("Copiada!")); }
    function copyTxt(t) { navigator.clipboard.writeText(t).then(() => alert("Copiado!")); }

    function showPage(p) {
        document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
        document.getElementById('tab-' + p).classList.add('active');
        if(p === 'admin') carregarPedidosAdmin();
        if(p === 'downloads') renderDownloads();
        window.scrollTo(0,0);
    }

    async function updateUserStatus(user) {
        currentUser = user;
        const display = document.getElementById('user-display');
        if (user) {
            display.innerText = user.email.split('@')[0];
            document.getElementById('auth-box').style.display = 'none';
            document.getElementById('profile-box').style.display = 'block';
            document.getElementById('profile-email').innerText = user.email;
            const { data } = await _supabase.from('profiles').select('is_admin').eq('id', user.id).single();
            if(data?.is_admin) document.getElementById('btn-acesso-admin').style.display = 'block';
        }
    }

    async function renderL() {
        const { data } = await _supabase.from('musicas').select('*').order('id', { ascending: false });
        if(data) {
            document.getElementById('vitrine').innerHTML = data.map(p => `
                <div class="prod-card">
                    <img src="${p.imagen_u || p.Imagen_u}">
                    <div class="prod-info">
                        <h3>${p.nome || p.Nome}</h3>
                        <span class="price">R$ ${parseFloat(p.pre√ßo || p.Pre√ßo).toFixed(2)}</span>
                        <audio controls src="${p.Audio_url}"></audio>
                        <button class="btn-primary" onclick="addCarrinho(${p.id}, '${p.nome || p.Nome}', ${p.pre√ßo || p.Pre√ßo})">Adicionar</button>
                    </div>
                </div>`).join('');
        }
    }

    function addCarrinho(id, nome, preco) {
        if(!currentUser) return showPage('conta');
        carrinho.push({ id, nome, preco, tempId: Date.now() });
        localStorage.setItem('MP_CART', JSON.stringify(carrinho));
        updateCartUI(); showPage('carrinho');
    }

    function updateCartUI() {
        const lista = document.getElementById('lista-carrinho');
        lista.innerHTML = carrinho.map(i => `<div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>${i.nome}</span><span>R$ ${i.preco}</span></div>`).join('');
        document.getElementById('carrinho-total').innerText = "Total: R$ " + carrinho.reduce((a,b)=>a+b.preco,0).toFixed(2);
    }

    async function enviarComprovante() {
        const file = document.getElementById('comprovante-file').files[0];
        if(!file) return alert("Anexe o comprovante!");
        try {
            const fileName = `${Date.now()}_comp.jpg`;
            await _supabase.storage.from('comprovantes').upload(fileName, file); 
            const { data: urlRes } = _supabase.storage.from('comprovantes').getPublicUrl(fileName);
            await _supabase.from('pedidos').insert([{ 
                usuario: currentUser.email, usuario_id: currentUser.id, 
                items: JSON.stringify(carrinho), comprovante_url: urlRes.publicUrl, status: 'pendente' 
            }]);
            alert("Enviado para an√°lise!");
            carrinho = []; localStorage.removeItem('MP_CART'); showPage('loja'); 
        } catch (e) { diagnostico("Upload Comprovante", e); }
    }

    async function renderDownloads() {
        if(!currentUser) return;
        const { data: pedidos } = await _supabase.from('pedidos').select('*').eq('usuario_id', currentUser.id);
        const container = document.getElementById('downloads-list');
        container.innerHTML = "";
        pedidos?.forEach(p => {
            JSON.parse(p.items).forEach(item => {
                let acao = p.status === 'aprovado' ? `<button class="btn-success" onclick="baixar(${item.id})">BAIXAR</button>` : `<div class="status-blink">PENDENTE</div>`;
                container.innerHTML += `<div class="card"><strong>${item.nome}</strong><br>${acao}</div>`;
            });
        });
    }

    async function baixar(id) {
        const { data: m } = await _supabase.from('musicas').select('audio_completo').eq('id', id).single();
        if(m) window.open(m.audio_completo, '_blank');
    }

    // --- AUTH E ADMIN ORIGINAIS ---
    async function handleLogin() {
        const e = document.getElementById('auth-email').value, s = document.getElementById('auth-password').value;
        const { data, error } = await _supabase.auth.signInWithPassword({ email: e, password: s });
        if (error) diagnostico("Login", error); else location.reload();
    }

    async function handleSignUp() {
        const e = document.getElementById('auth-email').value, s = document.getElementById('auth-password').value;
        const { error } = await _supabase.auth.signUp({ email: e, password: s });
        if (error) diagnostico("Cadastro", error); else alert("Confirme seu e-mail!");
    }

    async function handleLogout() { await _supabase.auth.signOut(); location.reload(); }
    function toggleAuthMode(s) { document.getElementById('login-actions').style.display = s ? 'none' : 'block'; document.getElementById('signup-actions').style.display = s ? 'block' : 'none'; }

    async function carregarPedidosAdmin() {
        const { data } = await _supabase.from('pedidos').select('*').eq('status', 'pendente');
        document.getElementById('corpo-tabela-admin').innerHTML = data?.map(p => `<tr><td>${p.usuario}</td><td><button onclick="window.open('${p.comprovante_url}')">VER</button></td><td><button onclick="aprovar(${p.id})">OK</button></td></tr>`).join('');
    }

    async function aprovar(id) { await _supabase.from('pedidos').update({status:'aprovado'}).eq('id', id); carregarPedidosAdmin(); }

    async function gerarLinkGenerico() {
        const fileCapa = document.getElementById('up-capa').files[0];
        const fileAudio = document.getElementById('up-audio').files[0];
        try {
            const nC = `capas/${Date.now()}.jpg`;
            await _supabase.storage.from('playbacks').upload(nC, fileCapa);
            const { data: rC } = _supabase.storage.from('playbacks').getPublicUrl(nC);
            document.getElementById('out-capa').value = rC.publicUrl;

            const nA = `audios/${Date.now()}.mp3`;
            await _supabase.storage.from('playbacks').upload(nA, fileAudio);
            const { data: rA } = _supabase.storage.from('playbacks').getPublicUrl(nA);
            document.getElementById('out-audio').value = rA.publicUrl;
            alert("Upload conclu√≠do!");
        } catch (e) { diagnostico("Upload Admin", e); }
    }

    init();
</script>
</body>
</html>
